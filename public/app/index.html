<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Личный кабинет</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; }
    .card { max-width: 520px; margin: 0 auto; padding: 24px; border: 1px solid #eee; border-radius: 16px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    p  { margin: 8px 0; color: #333; }
    button { padding: 12px 16px; border-radius: 12px; border: 0; cursor: pointer; font-weight: 600; }
    .primary { background: #2a9d8f; color: white; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Личный кабинет</h1>
    <div id="content">Загрузка...</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();  // растянуть WebApp
    tg.ready();

    async function main() {
      // initData — подписанная Телеграмом строка, её проверит бэкенд
      const initData = tg.initData || "";

      // 1) валидируем initData на бэкенде и сразу пытаемся получить ФИО из БД
      const res = await fetch("/api/auth/telegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData })
      });

      const data = await res.json();
      const root = document.getElementById("content");

      if (!data.ok) {
        root.innerHTML = "<p>Ошибка авторизации через Telegram. Попробуйте ещё раз.</p>";
        return;
      }

      if (data.user && (data.user.first_name || data.user.last_name)) {
        root.innerHTML = `
          <p>Здравствуйте, <b>${(data.user.first_name || "")} ${(data.user.last_name || "")}</b>!</p>
          <p>Добро пожаловать в личный кабинет.</p>
        `;
      } else {
        // нет ФИО в БД → показываем кнопку «Войти» в Додо ИС
        const btn = document.createElement("button");
        btn.className = "primary";
        btn.textContent = "Войти";
        btn.onclick = async () => {
          const s = await fetch("/api/oauth/start").then(r => r.json());
          if (s.url) {
            // открываем OAuth авторизацию в том же окне WebApp
            window.location.href = s.url;
          } else {
            alert("Не удалось начать авторизацию");
          }
        };
        root.innerHTML = "<p>Чтобы продолжить, выполните вход.</p>";
        root.appendChild(btn);
      }
    }

    main().catch(() => {
      document.getElementById("content").textContent = "Произошла ошибка. Обновите страницу.";
    });
  </script>
</body>
</html>
